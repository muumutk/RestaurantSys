@{
    ViewData["Title"] = "餐飲管理系統";
}

@{
    var warnings = ViewBag.InventoryWarnings as List<string>;
}

@if (warnings != null && warnings.Any())
{
    <div class="modal fade" id="inventoryWarningModal" tabindex="-1" aria-labelledby="inventoryWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryWarningModalLabel">庫存警示！</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>下列物品即將到期，請盡快處理：</p>
                    <hr>
                    <ul>
                        @foreach (var warning in warnings)
                        {
                            <li>@warning</li>
                        }
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">我知道了</button>
                </div>
            </div>
        </div>
    </div>
}

@* 新增訂單通知 Modal *@
<div class="modal fade" id="newOrderModal" tabindex="-1" aria-labelledby="newOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="newOrderModalLabel">🎉 新訂單通知！</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-bell fa-4x text-success mb-3"></i>
                <h4>您有新的訂單囉！</h4>
                <p class="text-muted mb-0">請至訂單管理頁面處理。</p>
            </div>
            <div class="modal-footer justify-content-center">
                <a href="@Url.Action("Index", "Orders")" class="btn btn-success">前往查看</a>
            </div>
        </div>
    </div>
</div>

<div class="gradient-bg text-white">
    <div class="container py-5">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3">餐飲管理系統</h1>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row g-4 mb-5">
        <div class="col-12 col-md-4">
            <div class="card shadow-sm p-4 h-100">
                <div class="d-flex align-items-center">
                    <div class="p-3 bg-soft-coral-light rounded-3">
                        <i class="fas fa-exclamation-triangle soft-coral fs-5"></i>
                    </div>
                    <div class="ms-3">
                        <p class="text-secondary mb-0">低庫存警示</p>
                        <p class="fs-4 fw-bold soft-coral mb-0">@ViewBag.LowStockCount</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <a asp-controller="Employees" asp-action="Index" class="text-decoration-none">
                <div class="card shadow-sm p-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="p-3 bg-sage-green-light rounded-3">
                            <i class="fas fa-users sage-green fs-5"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-secondary mb-0">員工總數</p>
                            <p class="fs-4 fw-bold text-dark mb-0">@ViewBag.EmployeeCount</p>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-12 col-md-4">
            <a asp-controller="Dishes" asp-action="Index" class="text-decoration-none">
                <div class="card shadow-sm p-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="p-3 bg-sky-blue-light rounded-3">
                            <i class="fas fa-utensils sky-blue fs-5"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-secondary mb-0">菜單項目</p>
                            <p class="fs-4 fw-bold text-dark mb-0">@ViewBag.MenuCount</p>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="mb-5">
        <h2 class="fs-3 fw-bold text-dark mb-4">管理功能</h2>
        <div class="row g-4">
            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Stocks" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-box sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">庫存管理</h3>
                        <p class="text-secondary mb-4">追蹤食材庫存及庫存預警</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="StockBatches" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-truck sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">進貨紀錄</h3>
                        <p class="text-secondary mb-4">追蹤每筆進貨</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Suppliers" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-building sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">供應商</h3>
                        <p class="text-secondary mb-4">管理所有供應商</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Employees" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-user-cog sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">員工帳號管理</h3>
                        <p class="text-secondary mb-4">新增員工帳號與權限設定</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Dishes" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-utensils sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">菜單管理</h3>
                        <p class="text-secondary mb-4">管理餐點項目與價格設定</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Orders" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-receipt sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">訂單管理</h3>
                        <p class="text-secondary mb-4">處理客戶訂單與出餐狀態</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="Stocks" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-chart-bar sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">報表分析</h3>
                        <p class="text-secondary mb-4">營收分析與經營數據統計</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="DishIngredients" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-chart-bar sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">餐點用量</h3>
                        <p class="text-secondary mb-4">各餐點的詳細食材組合</p>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <a asp-controller="DailyStockUsages" asp-action="Index" class="text-decoration-none card-hover d-block h-100">
                    <div class="feature-card">
                        <div class="p-3 bg-sage-green-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 4rem; height: 4rem;">
                            <i class="fas fa-chart-bar sage-green fs-4"></i>
                        </div>
                        <h3 class="fs-5 fw-bold text-dark mb-2">當日用量登記</h3>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @if (warnings != null && warnings.Any())
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var inventoryModal = new bootstrap.Modal(document.getElementById('inventoryWarningModal'), {
                    keyboard: false
                });
                inventoryModal.show();
            });
        </script>
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 使用定時器每 5 秒鐘發送一次請求，檢查新訂單
            const pollingInterval = 5000; // 5000 毫秒 = 5 秒

            function checkForNewOrders() {
                // 使用 AJAX 請求後端 API
                $.ajax({
                    url: '@Url.Action("CheckForNewOrders", "Orders", new { Area = "Admin" })',
                    type: 'GET',
                    success: function (response) {
                        // 檢查後端回傳的結果
                        if (response.hasNewOrders) {
                            console.log("發現新訂單！顯示通知。");
                            // 顯示新訂單 Modal
                            var newOrderModal = new bootstrap.Modal(document.getElementById('newOrderModal'), {
                                keyboard: false
                            });
                            newOrderModal.show();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("檢查新訂單時發生錯誤: " + error);
                    }
                });
            }

            // 啟動定時器
            setInterval(checkForNewOrders, pollingInterval);
        });
    </script>
}