@{
    ViewData["Title"] = "我的購物車";
}

<h1 class="text-center mb-4">@ViewData["Title"]</h1>

<!-- 流程步驟條 -->
@await Html.PartialAsync("_OrderStepPartial", 1)

<!-- 購物車內容 -->
<div id="cart-container" class="mt-4">
    <!-- 預設由 JS 動態生成 -->
</div>

@section Scripts {
    <script>
        // 金額格式化工具
        let toNTD = new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD',
            minimumFractionDigits: 0
        });

        function showMyCart() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let comfirmOrderUrl = '@Url.Action("Create", "Orders", new { area = "User" })';
            let continueShoppingUrl = '@Url.Action("Index", "Menu", new { area = "" })';

            let items = '';
            let sum = 0;
            let counter = 1;

            if (cart.length === 0) {
                document.getElementById('cart-container').innerHTML = `
                    <div class="text-center my-5">
                        <i class="bi bi-cart" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3">您的購物車是空的</h4>
                        <p class="text-muted">快去訂餐吧！</p>
                        <a href="${continueShoppingUrl}" class="btn btn-outline-dark px-4">前往訂餐</a>
                    </div>
                `;
            } else {
                items += `
                    <div class="table-responsive">
                        <table class="table table-hover" id="myCart">
                            <thead class="table-light">
                                <tr>
                                    <th>序號</th>
                                    <th>菜色名稱</th>
                                    <th>單價</th>
                                    <th>數量</th>
                                    <th>小計</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>`;

                for (let item of cart) {
                    let subtotal = item.DishPrice * item.Qty;
                    sum += subtotal;

                    items += `<tr>
                        <td>${counter++}</td>
                        <td>${item.DishName}</td>
                        <td>${toNTD.format(item.DishPrice)}</td>
                        <td>
                            <div class="input-group input-group-sm" style="width: 130px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="changeQty(${item.DishID}, -1)">-</button>
                                <input type="text" class="form-control text-center cart-qty" value="${item.Qty}" data-dish-id="${item.DishID}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="changeQty(${item.DishID}, 1)">+</button>
                            </div>
                        </td>
                        <td><span class="text-danger fw-bold subtotal-price">${toNTD.format(subtotal)}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="confirmRemove(${item.DishID})">
                                <i class="bi bi-trash3"></i> 移除
                            </button>
                        </td>
                    </tr>`;
                }

                items += `</tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end fw-bold">總計：</td>
                                <td colspan="2"><h4 class="text-danger fw-bold" id="total-sum">${toNTD.format(sum)}</h4></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <a href="${continueShoppingUrl}" class="btn btn-outline-dark me-2">
                        <i class="bi bi-shop"></i> 再繼續逛逛
                    </a>
                    <a href="${comfirmOrderUrl}" class="btn btn-outline-success">
                        <i class="bi bi-credit-card"></i> 前往結帳
                    </a>
                </div>`;

                document.getElementById('cart-container').innerHTML = items;
            }

            updateCartCount(cart);
        }

        function updateCartCount(cart) {
            let totalQty = cart.reduce((acc, item) => acc + item.Qty, 0);
            let countEl = document.getElementById("cart-count");
            if (countEl) countEl.innerText = totalQty;
        }

        function changeQty(dishID, change) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let item = cart.find(i => i.DishID === dishID);

            if (item) {
                if (item.Qty === 1 && change === -1) {
                    confirmRemove(dishID);
                } else {
                    item.Qty = Math.max(1, item.Qty + change);
                    localStorage.setItem("cart", JSON.stringify(cart));
                    showMyCart();
                }
            }
        }

        function confirmRemove(dishId) {
            if (confirm("確定要移除此商品嗎？")) {
                removeItem(dishId);
            }
        }

        function removeItem(dishId) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let updatedCart = cart.filter(item => item.DishID !== dishId);
            localStorage.setItem("cart", JSON.stringify(updatedCart));
            showMyCart();
        }

        function clearCart() {
            localStorage.removeItem("cart");
            showMyCart();
        }

        showMyCart();
    </script>
}
